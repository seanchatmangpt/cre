# External Egress Policies
# Control outbound traffic to external services

---
# Allow CRE app to access external HTTPS endpoints
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-https
  namespace: cre-system
spec:
  podSelector:
    matchLabels:
      app: cre-app
      allow-external-egress: "true"
  policyTypes:
  - Egress
  egress:
  # Allow HTTPS to any destination
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        # Block private IP ranges
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    ports:
    - protocol: TCP
      port: 443

---
# Allow backup agent to access GCS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backup-to-gcs
  namespace: cre-system
spec:
  podSelector:
    matchLabels:
      app: backup-agent
  policyTypes:
  - Egress
  egress:
  # Allow HTTPS for GCS access
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 443
  # Allow GKE metadata server
  - to:
    - ipBlock:
        cidr: 169.254.169.254/32
    ports:
    - protocol: TCP
      port: 988

---
# Block all other external egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: block-unapproved-external-egress
  namespace: cre-system
spec:
  podSelector:
    matchExpressions:
    - key: allow-external-egress
      operator: DoesNotExist
  policyTypes:
  - Egress
  egress:
  # Only allow DNS and internal cluster communication
  - to:
    - namespaceSelector: {}
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8  # Internal cluster CIDR
